<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to DOCX OCR - Processing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-100 mb-4">
                    <svg id="status-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Processing your PDF</h1>
                <p id="status-message" class="text-gray-600">Converting to DOCX with OCR. Please wait...</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex items-center mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <div>
                        <span class="block text-sm font-medium text-gray-900">{{ filename }}</span>
                        <span class="block text-xs text-gray-500">File being processed</span>
                    </div>
                </div>
                
                <!-- Progress bar -->
                <div class="mt-4">
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span id="progress-percent" class="text-xs font-semibold inline-block text-indigo-600">
                                    {{ progress.percentage }}%
                                </span>
                            </div>
                            <div class="text-right">
                                <span id="progress-status" class="text-xs font-semibold inline-block text-indigo-600 capitalize">
                                    {{ progress.status }}
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-indigo-200">
                            <div id="progress-bar" style="width:{{ progress.percentage }}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-500 transition-all duration-500 ease-out"></div>
                        </div>
                        <p id="progress-detail" class="text-xs text-gray-500">{{ progress.message }}</p>
                    </div>
                </div>
            </div>
            
            <div class="text-xs text-center text-gray-500 mb-6">
                <p>Please don't close this window. Your file is being processed.</p>
                <p class="mt-1">This may take several minutes depending on the file size and complexity.</p>
            </div>
            
            <div id="cancel-button" class="text-center">
                <a href="{{ url_for('index') }}" class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Cancel process
                </a>
            </div>
        </div>
    </div>
    
    <script>
        // Get elements for updating
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressStatus = document.getElementById('progress-status');
        const progressDetail = document.getElementById('progress-detail');
        const statusMessage = document.getElementById('status-message');
        const statusIcon = document.getElementById('status-icon');
        const cancelButton = document.getElementById('cancel-button');
        
        // Get conversion ID for WebSocket connection
        const conversionId = '{{ conversion_id }}';
        
        // Setup WebSocket for real-time progress updates
        let wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        let wsHost = window.location.hostname;
        let wsPort = '8012'; // Make sure this matches the WebSocket server port
        
        const socket = new WebSocket(`${wsProtocol}//${wsHost}:${wsPort}/progress/${conversionId}`);
        
        // Handle WebSocket events
        socket.onopen = function(e) {
            console.log('WebSocket connection established');
        };
        
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateProgress(data);
        };
        
        socket.onclose = function(event) {
            if (!event.wasClean) {
                console.log('WebSocket connection closed unexpectedly');
                // Fall back to polling
                startPolling();
            }
        };
        
        socket.onerror = function(error) {
            console.log('WebSocket error:', error);
            // Fall back to polling
            startPolling();
        };
        
        // Polling as fallback if WebSocket fails
        let pollingInterval;
        
        function startPolling() {
            if (!pollingInterval) {
                pollingInterval = setInterval(pollProgress, 1000);
            }
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }
        
        function pollProgress() {
            fetch(`/api/progress/${conversionId}`)
                .then(response => response.json())
                .then(data => {
                    updateProgress(data);
                })
                .catch(error => {
                    console.error('Error fetching progress:', error);
                });
        }
        
        // Update UI based on progress data
        function updateProgress(data) {
            // Update progress bar
            progressBar.style.width = `${data.percentage}%`;
            progressPercent.textContent = `${data.percentage}%`;
            progressStatus.textContent = data.status;
            progressDetail.textContent = data.message || '';
            
            // Update status message based on status
            if (data.status === 'processing') {
                statusMessage.textContent = 'Converting to DOCX with OCR. Please wait...';
                statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />';
                statusIcon.classList.add('animate-pulse');
                statusIcon.classList.remove('text-green-600', 'text-red-600');
                statusIcon.classList.add('text-indigo-600');
            } else if (data.status === 'complete') {
                statusMessage.textContent = 'Conversion complete! Redirecting...';
                statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />';
                statusIcon.classList.remove('animate-pulse', 'text-indigo-600', 'text-red-600');
                statusIcon.classList.add('text-green-600');
                cancelButton.classList.add('hidden');
                
                // Redirect to success page
                setTimeout(() => {
                    window.location.href = '/success';
                }, 1000);
            } else if (data.status === 'error') {
                statusMessage.textContent = 'Error during conversion.';
                statusIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';
                statusIcon.classList.remove('animate-pulse', 'text-indigo-600', 'text-green-600');
                statusIcon.classList.add('text-red-600');
            }
        }
        
        // Check progress immediately on page load
        pollProgress();
        
        // Send heartbeat to keep WebSocket connection alive
        setInterval(() => {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send('ping');
            }
        }, 30000);
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            stopPolling();
            socket.close();
        });
    </script>
</body>
</html>
